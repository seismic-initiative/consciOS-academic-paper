\documentclass[12pt]{article}

% Packages for fonts and encoding
\usepackage{fontspec}
\IfFontExistsTF{TeX Gyre Termes}{\setmainfont{TeX Gyre Termes}}{\setmainfont{Times New Roman}}

% Colors (needed for \textcolor in footer)
\usepackage{xcolor}

% Page geometry
\usepackage[margin=1in,headheight=30pt,headsep=18pt,footskip=30pt]{geometry}

% Headers and footers
\usepackage{fancyhdr}
\usepackage{graphicx}

% Math and symbols
\usepackage{amsmath,amssymb}

% Tables and figures
\usepackage{longtable,booktabs,array}
\usepackage{calc}  % For table column calculations
\usepackage{caption}

% etoolbox for various hooks
\usepackage{etoolbox}

% needspace to prevent orphaned section headings
\usepackage{needspace}

% Title formatting with titlesec (MUST come before hyperref)
% Load WITHOUT nobottomtitles to allow our needspace logic to control page breaks
% Use titlesec's built-in nobottomtitles* to keep headings off the final ~2 lines automatically
\usepackage[nobottomtitles*]{titlesec}
%% Space threshold before a heading triggers a page break (here ≈ 15 % of text height ≈ 2 lines)
% Tighter threshold (~2 lines)
\renewcommand{\bottomtitlespace}{0.05\textheight}
% Standard formatting: # → \section, ## → \subsection, #### → \subsubsection
\titleformat{\section}{\Large\bfseries\rmfamily}{\thesection}{1em}{}
\titleformat{\subsection}{\large\bfseries\rmfamily}{\thesubsection}{1em}{}
\titleformat{\subsubsection}{\normalsize\bfseries\rmfamily}{\thesubsubsection}{1em}{}
\titleformat{\paragraph}[block]{\normalsize\bfseries\rmfamily}{\theparagraph}{0.5em}{}
\titleformat{\subparagraph}[block]{\normalsize\bfseries\rmfamily}{\thesubparagraph}{0.5em}{}

% Spacing around headings (more space above than below for visual hierarchy)
% Using fixed spacing (no plus/minus) so LaTeX can't stretch to avoid breaks
\titlespacing*{\section}{0pt}{4ex}{1.2ex}
\titlespacing*{\subsection}{0pt}{3ex}{1ex}
\titlespacing*{\subsubsection}{0pt}{2ex}{0.8ex}
\titlespacing*{\paragraph}{0pt}{1.5ex}{0.8ex}
\titlespacing*{\subparagraph}{0pt}{1.2ex}{0.7ex}

% Reduce section penalties to allow page breaks before sections
\makeatletter
\@secpenalty=-50
\makeatother

% (Removed manual needspace hooks – titlesec now handles bottom headings)

% List spacing (MUST come before hyperref)
\usepackage{enumitem}
\setlist{topsep=6pt, partopsep=0pt, itemsep=6pt, parsep=3pt}
% Override pandoc's tightlist command
\providecommand{\tightlist}{%
  \setlength{\itemsep}{6pt}\setlength{\parskip}{3pt}}

% Hyperlinks (load AFTER titlesec and enumitem for proper anchors/bookmarks)
\usepackage[hidelinks]{hyperref}
\hypersetup{
  bookmarks=true,
  bookmarksopen=true,
  bookmarksnumbered=true,
  bookmarksdepth=4,
  pdfstartview=FitH,
  breaklinks=true
}
\usepackage{bookmark}

% Fix section depth for proper navigation
\setcounter{tocdepth}{4}
\setcounter{secnumdepth}{4}

% Better spacing
\setlength{\parskip}{0.5em}
\setlength{\parindent}{0pt}

% Natural page breaks with consistent bottom margins
\raggedbottom

% Widow and orphan control (prevent single lines at top/bottom of pages)
% Reduced from 10000 to allow needspace to work properly
\widowpenalty=150
\clubpenalty=150
\displaywidowpenalty=150

% Prevent page breaks after bold paragraph headers (like "Experiment 2:" or "**Echo-Self**")
% Removed \nopagebreak as it was overriding needspace logic
% \usepackage{xparse}
% \let\oldtextbf\textbf
% \renewcommand{\textbf}[1]{\oldtextbf{#1}\nopagebreak[4]}

% Micro-typography to smooth justification
\usepackage{microtype}
\setlength{\emergencystretch}{3em}

% Make long tables more forgiving with line breaks
\AtBeginEnvironment{longtable}{\sloppy}

% Abstract formatting - centered title, widened to match title feel, normal text size
\usepackage{abstract}
\renewcommand{\abstractnamefont}{\normalfont\normalsize\bfseries\rmfamily\centering}
\renewcommand{\abstracttextfont}{\normalfont\normalsize}
% Make abstract width closer to title (85% textwidth -> ~7.5% margins)
\setlength{\absleftindent}{0.075\textwidth}
\setlength{\absrightindent}{0.075\textwidth}

% Reduce space between Abstract title and text - use negative vspace in abstractname
\renewcommand{\abstractname}{Abstract\vspace{-0.7em}}
\setlength{\absparindent}{0pt}
\setlength{\abstitleskip}{-4pt}

% Figure spacing and captions (IEEE style: "Fig." not "Figure")
\DeclareCaptionLabelFormat{bold-label}{\textbf{#1 #2}}
\captionsetup{labelformat=bold-label,labelsep=period,font=small}
% IEEE style: use "Fig." instead of "Figure"
\renewcommand{\figurename}{Fig.}
\setlength{\abovecaptionskip}{14pt}
\setlength{\belowcaptionskip}{8pt}
\setlength{\textfloatsep}{16pt}
\setlength{\intextsep}{24pt}

% IEEE equation spacing (approximately one line above/below display equations)
\setlength{\abovedisplayskip}{12pt plus 3pt minus 6pt}
\setlength{\belowdisplayskip}{12pt plus 3pt minus 6pt}
\setlength{\abovedisplayshortskip}{6pt plus 3pt minus 3pt}
\setlength{\belowdisplayshortskip}{6pt plus 3pt minus 3pt}

% Table spacing
\renewcommand{\arraystretch}{1.35}
\setlength{\LTpre}{10pt}
\setlength{\LTpost}{12pt}

% Configure headers and footers
\pagestyle{fancy}
\fancyhf{}
\fancyhead[C]{\small $title$}
\renewcommand{\headrulewidth}{0.2pt}
% Custom short footer rule and page number
  \renewcommand{\footrulewidth}{0pt}
  \fancyfoot[C]{\raisebox{-6pt}{\thepage}}

% Improved footnote spacing for better readability
\setlength{\footnotesep}{12pt}  % Space between separator and footnote text
\setlength{\skip\footins}{12pt} % Space between main text and separator
% Prevent footnotes from splitting across pages
\interfootnotelinepenalty=10000
\makeatletter
\renewcommand\footnoterule{%
  \hrule width 0.4\columnwidth height 0.2pt % Standard academic width
}
\makeatother

% First page style
\fancypagestyle{plain}{%
  \fancyhf{}
  % Seismic logo on first page (left header, 40px ≈ 30pt high)
  \fancyhead[L]{\raisebox{-8pt}{\hspace{-6pt}\includegraphics[height=30pt]{seismic-logo.png}}}
  \fancyhead[R]{\small 2025-08-14}
  \renewcommand{\headrulewidth}{0.2pt}
  \renewcommand{\footrulewidth}{0pt}
  % Email correspondence footnote on first page only (IEEE style with asterisk)
  \fancyfoot[L]{\raisebox{12pt}{\small\begin{minipage}[b]{0.60\textwidth}\raggedright\rule{0.4\columnwidth}{0.2pt}\\[1pt]\textsuperscript{*}Email correspondence: \textcolor{blue}{\href{mailto:han.kay@goseismic.org}{han.kay@goseismic.org}}\end{minipage}}}
  \fancyfoot[C]{\raisebox{-6pt}{\thepage}}
}

% Float behavior: keep figures near their references while allowing flexible placement
\usepackage{placeins}
\usepackage{float}
\renewcommand{\topfraction}{0.85}
\renewcommand{\bottomfraction}{0.70}
\renewcommand{\textfraction}{0.15}
\renewcommand{\floatpagefraction}{0.80}
\setcounter{topnumber}{2}
\setcounter{bottomnumber}{2}
\setcounter{totalnumber}{4}
% Manual float barriers can be inserted where needed with \FloatBarrier

% Increase space above title by adding extra vspace before maketitle block
\makeatletter
\renewcommand{\maketitle}{%
  \thispagestyle{plain}%
  \vspace*{2.0cm}% extra space from header lines
  \begin{center}%
    \parbox{0.85\textwidth}{\centering\LARGE\bfseries $title$}\par
    \vspace{0.40cm}% more space after main title
    {\large\bfseries Kılıçhan (Han Kay) Kaynak$$^*$$\par}%
    \vspace{0.12cm}% slightly tighter before affiliation
    {\normalsize Seismic Labs (Independent Researcher)\par}%
  \end{center}%
  \vspace{0.25cm}% tighter gap to abstract
}
\makeatother

% Custom title block - DISABLE section numbering
\setcounter{secnumdepth}{0}

% (Removed duplicate maketitle definition)

% Appendix figure numbering: reset counter and add "A" prefix
\usepackage{chngcntr}
\newcommand{\appendixfigures}{%
  \setcounter{figure}{0}%
  \renewcommand{\thefigure}{A\arabic{figure}}%
}

\begin{document}

\maketitle

$if(abstract)$
\begin{abstract}
$abstract$
\end{abstract}
\vspace{-0.5\baselineskip}
$endif$

\clearpage
\pagestyle{fancy}

$body$

\end{document}
