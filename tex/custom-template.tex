\documentclass[12pt]{article}

% Packages for fonts and encoding
\usepackage{fontspec}
\IfFontExistsTF{TeX Gyre Termes}{\setmainfont{TeX Gyre Termes}}{\setmainfont{Times New Roman}}

% Colors (needed for \textcolor in footer)
\usepackage{xcolor}

% Page geometry
\usepackage[margin=1in,headheight=30pt,headsep=18pt,footskip=30pt]{geometry}

% Headers and footers
\usepackage{fancyhdr}
\usepackage{graphicx}

% Math and symbols
\usepackage{amsmath,amssymb}

% Tables and figures
\usepackage{longtable,booktabs,array}
\usepackage{calc}  % For table column calculations
\usepackage{caption}

% etoolbox for various hooks
\usepackage{etoolbox}

% needspace to prevent orphaned section headings
\usepackage{needspace}

% Title formatting with titlesec (MUST come before hyperref)
\usepackage{titlesec}
% Standard formatting: # → \section, ## → \subsection, #### → \subsubsection
\titleformat{\section}{\Large\bfseries\rmfamily}{\thesection}{1em}{}
\titleformat{\subsection}{\large\bfseries\rmfamily}{\thesubsection}{1em}{}
\titleformat{\subsubsection}{\normalsize\bfseries\rmfamily}{\thesubsubsection}{1em}{}
\titleformat{\paragraph}[block]{\normalsize\bfseries\rmfamily}{\theparagraph}{0.5em}{}
\titleformat{\subparagraph}[block]{\normalsize\bfseries\rmfamily}{\thesubparagraph}{0.5em}{}

% Spacing around headings (more space above than below for visual hierarchy)
\titlespacing*{\section}{0pt}{4ex plus 1ex minus 0.5ex}{1.2ex plus 0.3ex}
\titlespacing*{\subsection}{0pt}{3ex plus 0.8ex minus 0.3ex}{1ex plus 0.2ex}
\titlespacing*{\subsubsection}{0pt}{2ex plus 0.5ex minus 0.2ex}{0.8ex plus 0.2ex}
\titlespacing*{\paragraph}{0pt}{1.5ex plus 0.5ex minus 0.2ex}{0.8ex plus 0.2ex}
\titlespacing*{\subparagraph}{0pt}{1.2ex plus 0.5ex minus 0.2ex}{0.7ex plus 0.2ex}

% Prevent orphaned section headings (ensure sufficient content follows)
% Modified needspace to end with \vskip 0pt to avoid conflict with section commands
% Values: section needs ~4 lines (for section+subsection cases), subsection/subsubsection need less
\newcommand{\safeneedspace}[1]{\needspace{#1}\vskip 0pt}
\pretocmd{\section}{\safeneedspace{2.5\baselineskip}}{}{}
\pretocmd{\subsection}{\safeneedspace{2.0\baselineskip}}{}{}
\pretocmd{\subsubsection}{\safeneedspace{1.5\baselineskip}}{}{}

% List spacing (MUST come before hyperref)
\usepackage{enumitem}
\setlist{topsep=6pt, partopsep=0pt, itemsep=6pt, parsep=3pt}
% Override pandoc's tightlist command
\providecommand{\tightlist}{%
  \setlength{\itemsep}{6pt}\setlength{\parskip}{3pt}}

% Hyperlinks (load AFTER titlesec and enumitem for proper anchors/bookmarks)
\usepackage[hidelinks]{hyperref}
\hypersetup{
  bookmarks=true,
  bookmarksopen=true,
  bookmarksnumbered=true,
  bookmarksdepth=4,
  pdfstartview=FitH,
  breaklinks=true
}
\usepackage{bookmark}

% Fix section depth for proper navigation
\setcounter{tocdepth}{4}
\setcounter{secnumdepth}{4}

% Better spacing
\setlength{\parskip}{0.5em}
\setlength{\parindent}{0pt}

% Natural page breaks with consistent bottom margins
\raggedbottom

% Widow and orphan control (prevent single lines at top/bottom of pages)
\widowpenalty=10000
\clubpenalty=10000
\displaywidowpenalty=10000

% Prevent page breaks after bold paragraph headers (like "Experiment 2:" or "**Echo-Self**")
\usepackage{xparse}
% Add penalty after textbf to discourage breaks
\let\oldtextbf\textbf
\renewcommand{\textbf}[1]{\oldtextbf{#1}\nopagebreak[4]}

% Micro-typography to smooth justification
\usepackage{microtype}
\setlength{\emergencystretch}{3em}

% Make long tables more forgiving with line breaks
\AtBeginEnvironment{longtable}{\sloppy}

% Abstract formatting - centered title, widened to match title feel, normal text size
\usepackage{abstract}
\renewcommand{\abstractnamefont}{\normalfont\normalsize\bfseries\rmfamily\centering}
\renewcommand{\abstracttextfont}{\normalfont\normalsize}
% Make abstract width closer to title (85% textwidth -> ~7.5% margins)
\setlength{\absleftindent}{0.075\textwidth}
\setlength{\absrightindent}{0.075\textwidth}

% Reduce space between Abstract title and text - use negative vspace in abstractname
\renewcommand{\abstractname}{Abstract\vspace{-0.7em}}
\setlength{\absparindent}{0pt}
\setlength{\abstitleskip}{-4pt}

% Figure spacing and captions (IEEE style: "Fig." not "Figure")
\DeclareCaptionLabelFormat{bold-label}{\textbf{#1 #2}}
\captionsetup{labelformat=bold-label,labelsep=period,font=small}
% IEEE style: use "Fig." instead of "Figure"
\renewcommand{\figurename}{Fig.}
\setlength{\abovecaptionskip}{14pt}
\setlength{\belowcaptionskip}{8pt}
\setlength{\textfloatsep}{16pt}
\setlength{\intextsep}{24pt}

% IEEE equation spacing (approximately one line above/below display equations)
\setlength{\abovedisplayskip}{12pt plus 3pt minus 6pt}
\setlength{\belowdisplayskip}{12pt plus 3pt minus 6pt}
\setlength{\abovedisplayshortskip}{6pt plus 3pt minus 3pt}
\setlength{\belowdisplayshortskip}{6pt plus 3pt minus 3pt}

% Table spacing
\renewcommand{\arraystretch}{1.35}
\setlength{\LTpre}{10pt}
\setlength{\LTpost}{12pt}

% Configure headers and footers
\pagestyle{fancy}
\fancyhf{}
\fancyhead[C]{\small $title$}
\renewcommand{\headrulewidth}{0.2pt}
% Custom short footer rule and page number
\renewcommand{\footrulewidth}{0pt}
\fancyfoot[C]{\raisebox{-6pt}{\thepage}}

% First page style
\fancypagestyle{plain}{%
  \fancyhf{}
  % Seismic logo on first page (left header, 40px ≈ 30pt high)
  \fancyhead[L]{\raisebox{-8pt}{\hspace{-6pt}\includegraphics[height=30pt]{seismic-logo.png}}}
  \fancyhead[R]{\small 2025-08-14}
  \renewcommand{\headrulewidth}{0.2pt}
  \renewcommand{\footrulewidth}{0pt}
  % Left-aligned short rule above the email (first page only)
  \fancyfoot[L]{\raisebox{8pt}{\small\begin{minipage}[b]{0.60\textwidth}\raggedright \rule{0.3\textwidth}{0.2pt}\\[2pt]\textsuperscript{*}Email correspondence: \textcolor{blue}{\href{mailto:han.kay@goseismic.org}{han.kay@goseismic.org}}\end{minipage}}}
  \fancyfoot[C]{\raisebox{-6pt}{\thepage}}
}

% Float behavior: keep figures near their references while allowing flexible placement
\usepackage{placeins}
\renewcommand{\topfraction}{0.85}
\renewcommand{\bottomfraction}{0.70}
\renewcommand{\textfraction}{0.15}
\renewcommand{\floatpagefraction}{0.80}
\setcounter{topnumber}{2}
\setcounter{bottomnumber}{2}
\setcounter{totalnumber}{4}
% Manual float barriers can be inserted where needed with \FloatBarrier

% Increase space above title by adding extra vspace before maketitle block
\makeatletter
\renewcommand{\maketitle}{%
  \thispagestyle{plain}%
  \vspace*{2.0cm}% extra space from header lines
  \begin{center}%
    \parbox{0.85\textwidth}{\centering\LARGE\bfseries $title$}\par
    \vspace{0.40cm}% more space after main title
    {\large\bfseries Kılıçhan (Han Kay) Kaynak$$^*$$\par}%
    \vspace{0.12cm}% slightly tighter before affiliation
    {\normalsize Seismic Labs (Independent Researcher)\par}%
  \end{center}%
  \vspace{0.25cm}% tighter gap to abstract
}
\makeatother

% Custom title block - DISABLE section numbering
\setcounter{secnumdepth}{0}

% (Removed duplicate maketitle definition)

% Appendix figure numbering: reset counter and add "A" prefix
\usepackage{chngcntr}
\newcommand{\appendixfigures}{%
  \setcounter{figure}{0}%
  \renewcommand{\thefigure}{A\arabic{figure}}%
}

\begin{document}

\maketitle

$if(abstract)$
\begin{abstract}
$abstract$
\end{abstract}
\vspace{-0.5\baselineskip}
$endif$

$body$

\end{document}
